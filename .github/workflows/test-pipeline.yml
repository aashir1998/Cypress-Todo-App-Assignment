name: Cypress UI And API Sequential Tests

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

env:
  NODE_VERSION: "18"
  BACKEND_PORT: "3001"
  FRONTEND_PORT: "3000"
  BACKEND_URL: "http://localhost:3001"
  FRONTEND_URL: "http://localhost:3000"

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      # Checkout code
      - uses: actions/checkout@v4

      # Setup Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # Install dependencies once
      - name: Install dependencies (Root + FE + BE + Cypress)
        run: |
          rm -rf node_modules "Todo App/frontend/node_modules" "Todo App/backend/node_modules" "Automation Framework/node_modules"
          npm cache clean --force
          npm run install:all

      # Start both frontend and backend servers
      - name: Start Application Servers
        run: |
          npm start &
          timeout 90 bash -c 'until curl -sf ${{ env.BACKEND_URL }}/health; do sleep 3; done'
          timeout 90 bash -c 'until curl -sf ${{ env.FRONTEND_URL }}; do sleep 3; done'
          echo "Both servers ready!"

      # Step 1: API Tests
      - name: Run API Tests
        id: api
        run: npm run api:tests
        env:
          CI: true

      # Step 2: Smoke Tests (only if API passed)
      - name: Run Smoke Tests
        if: success()  # only run if previous step succeeded
        id: smoke
        run: npm run e2e:smoke:tests
        env:
          CI: true

      # Step 3: Regression Tests (only if Smoke passed)
      - name: Run Regression Tests
        if: success()  # only run if smoke succeeded
        run: npm run e2e:regression:tests
        env:
          CI: true

      # Upload reports
      - name: Upload Cypress Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Cypress-Reports
          path: Automation Framework/cypress/reports/html