name: 🚀 Cypress Regression Tests

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  regression-tests:
    name: 🧪 Cypress E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ⚡ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ⚡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            Todo App/frontend/package-lock.json
            Todo App/backend/package-lock.json

      - name: 📦 Install all dependencies
        run: npm run install:all

      - name: 🚀 Start Backend and Frontend
        run: npm run start &
      
      - name: ⏳ Wait for services to start
        run: sleep 10

      - name: ✅ Verify Cypress
        run: npx cypress verify --project 'Automation Framework'

      - name: 🧪 Run Cypress Regression Tests
        run: npm run ci:e2e

      - name: 📊 Upload Cypress Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-report-${{ github.run_number }}
          path: Automation Framework/cypress/reports/html
          retention-days: 7

      - name: 🧹 Cleanup
        if: always()
        run: |
          pkill -f "node.*Todo App" || true
          pkill -f "react-scripts" || true
          pkill -f "concurrently" || true

      - name: 📋 Test Results Summary
        if: always()
        run: |
          echo "## 🧪 Cypress Test Results" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Node Version | 18 |" >> $GITHUB_STEP_SUMMARY
          echo "| Browser | Chrome (Headless) |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | $(date -u) |" >> $GITHUB_STEP_SUMMARY
          if [ -f "Automation Framework/cypress/reports/html/index.html" ]; then
            echo "| Report Status | ✅ Generated |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Report Status | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "| Overall Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
